name: Demo Run

on:
  push:
    branches: [main, feat/**]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  demo:
    name: Run IPTV Aggregator Demo
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp pydantic lxml sqlalchemy rapidfuzz beautifulsoup4 python-dateutil
      
      - name: ðŸš€ Run demo
        run: |
          python demo.py
      
      - name: ðŸ“Š Display results
        run: |
          echo "=== Generated Files ==="
          ls -lh output/
          echo ""
          echo "=== Playlist Preview ==="
          head -20 output/demo.m3u
          echo ""
          echo "=== Database Stats ==="
          sqlite3 output/demo.db "SELECT COUNT(*) as channels FROM channels;"
          sqlite3 output/demo.db "SELECT COUNT(*) as streams FROM streams;"
          echo ""
          echo "=== Sample Channels ==="
          sqlite3 output/demo.db "SELECT id, name, country FROM channels LIMIT 5;"
      
      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptv-demo-output
          path: |
            output/demo.m3u
            output/demo_metadata.json
            output/demo.db
          retention-days: 7
      
      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metadata = JSON.parse(fs.readFileSync('output/demo_metadata.json', 'utf8'));
            
            const comment = `## ðŸŽ¬ Demo Execution Results
            
            âœ… Successfully executed IPTV Aggregator demo!
            
            ### ðŸ“Š Statistics
            - **Total Channels**: ${metadata.total_channels}
            - **Version**: ${metadata.version}
            
            ### ðŸ“ Artifacts
            Download generated files from the workflow artifacts:
            - \`demo.m3u\` - M3U8 playlist
            - \`demo_metadata.json\` - Channel metadata
            - \`demo.db\` - SQLite database
            
            ### ðŸ” Sample Channels
            ${metadata.channels.slice(0, 5).map(ch => 
              `- **${ch.name}** (${ch.country || 'N/A'}) - ${ch.streams_count} stream(s)`
            ).join('\n')}
            
            ---
            ðŸ¤– Automated by GitHub Actions`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });