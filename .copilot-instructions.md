# IPTV Aggregator - Agent Context

## Project Overview
Multi-source IPTV aggregator with unified channels + EPG master dataset.

## Master Dataset Location
- **Path**: `data/master-dataset/`
- **Update frequency**: Every 6 hours via GitHub Actions
- **Format**: Parquet (Apache Arrow, Snappy compression)
- **Branch**: `dataset-auto` (auto-updated)

## Dataset Schema

### channels.parquet
Master registry of TV channels combining:
- iptv-org canonical IDs (immutable primary keys)
- IPTVPortal fuzzy matches (85% threshold via RapidFuzz)
- Usage analytics from ClickHouse (30-day rolling window)
- Quality scores (weighted: match=40%, usage=30%, metadata=30%)

**Key columns**:
- `channel_id` (PK): iptv-org ID (e.g., "BBC1.uk")
- `name`: Display name
- `country`: ISO country code
- `portal_id`: IPTVPortal match (nullable)
- `quality_score`: 0.0-1.0 composite score
- `epg_sites`: Available EPG sources (JSON array)

### streams.parquet
Stream URLs and health metrics:
- `channel`: FK to channels.channel_id
- `url`: Stream URL
- `is_working`: Boolean health check
- `uptime_ratio_7d`: 7-day SLA percentage
- `provider`: Extracted from URL (YouTube, Twitch, etc.)

### programs.parquet
Electronic Program Guide (14-day window):
- `channel_id`: FK to channels.channel_id
- `start_utc`: Program start time
- `stop_utc`: Program end time
- `title`: Program title
- `description`: Full description
- `epg_source`: Source site (e.g., "arirang.com")

## Usage in Issues/PRs

When debugging EPG/channel problems:
1. **Check existence**: Query `channels.parquet` by name/ID
2. **Verify EPG**: Check `programs.parquet` for date range
3. **Stream health**: Validate URLs in `streams.parquet`

Example queries (DuckDB CLI):
```sql
-- Find channel by fuzzy name
SELECT * FROM 'data/master-dataset/channels.parquet'
WHERE name ILIKE '%BBC%' AND quality_score > 0.7;

-- Check EPG coverage
SELECT channel_id, COUNT(*) as programs
FROM 'data/master-dataset/programs.parquet'
WHERE start_utc >= CURRENT_DATE
GROUP BY channel_id;
```

## Code Patterns

### IPTVPortal API Authentication
```python
from tools.iptvportal_loader import IPTVPortalClient

session_id = os.getenv("IPTVPORTAL_SESSION_ID")
client = IPTVPortalClient(session_id=session_id)
channels = client.get_channels(active_only=True)
```

### Loading Master Dataset
```python
import pandas as pd

channels = pd.read_parquet("data/master-dataset/channels.parquet")
streams = pd.read_parquet("data/master-dataset/streams.parquet")
programs = pd.read_parquet("data/master-dataset/programs.parquet")
```

## Maintenance Tasks

Add to recurrent issues:
- [ ] Weekly: Validate dataset completeness (channels with 0 streams)
- [ ] Monthly: Review fuzzy match thresholds (false positives)
- [ ] Quarterly: Audit EPG source coverage by country
- [ ] On-demand: Update IPTVPortal session when expired

## Secrets Required

- `IPTVPORTAL_SESSION_ID`: Session cookie for IPTVPortal API
- `CLICKHOUSE_HOST`: (Optional) ClickHouse for usage analytics
- `CLICKHOUSE_USER`: (Optional) ClickHouse username
- `CLICKHOUSE_PASSWORD`: (Optional) ClickHouse password

## Architecture Notes

- **Session-based auth**: IPTVPortal uses `Iptvportal-Authorization: sessionid=<ID>` header
- **JSONRPC 2.0**: All API calls follow JSONRPC spec
- **Fuzzy matching**: Uses RapidFuzz with `token_sort_ratio` scorer
- **EPG source**: iptv-org/epg grabber via Docker (Node.js based)
- **Storage**: SQLite intermediate â†’ Parquet final export
